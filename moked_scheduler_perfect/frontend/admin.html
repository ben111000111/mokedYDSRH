<!doctype html>
<html lang="he" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>××—××© | ××¢×¨×›×ª ××•×§×“ ××¦×•×§×” ×™×“ ×©×¨×”</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;500;700;900&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { font-family: 'Heebo', sans-serif; background-color: #f1f5f9; }
    .nav-btn.active { background-color: #1e293b; color: white; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
    .panel { animation: fadeIn 0.3s ease-out; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
  </style>
</head>

<body class="min-h-screen text-slate-800">
<div id="toast" style="display:none;"></div>

<div class="flex flex-col lg:flex-row min-h-screen">
  
  <aside class="w-full lg:w-72 bg-white border-l border-slate-200 flex flex-col shrink-0">
    <div class="p-6 border-b border-slate-100 flex items-center gap-3">
      <div id="logo" class="h-8 w-auto"></div>
      <div>
        <div class="text-sm font-black text-slate-900">×¤×× ×œ × ×™×”×•×œ</div>
        <div id="topNow" class="text-[10px] font-bold text-slate-400"></div>
      </div>
    </div>

    <nav class="p-4 space-y-2 flex-1 overflow-y-auto">
      <button data-tab="requests" class="nav-btn w-full text-right px-4 py-3 rounded-xl font-bold text-slate-500 hover:bg-slate-50 transition-all flex items-center justify-between group">
        <span>ğŸ“¬ ×‘×§×©×•×ª ×××ª×™× ×•×ª</span>
        <span id="reqCount" class="bg-rose-100 text-rose-700 text-xs py-0.5 px-2 rounded-full hidden group-[.active]:bg-white group-[.active]:text-slate-900">0</span>
      </button>
      <button data-tab="users" class="nav-btn w-full text-right px-4 py-3 rounded-xl font-bold text-slate-500 hover:bg-slate-50 transition-all">ğŸ‘¥ ××©×ª××©×™×</button>
      <button data-tab="shifts" class="nav-btn w-full text-right px-4 py-3 rounded-xl font-bold text-slate-500 hover:bg-slate-50 transition-all">ğŸ“… × ×™×”×•×œ ××©××¨×•×ª</button>
      <button data-tab="generate" class="nav-btn w-full text-right px-4 py-3 rounded-xl font-bold text-slate-500 hover:bg-slate-50 transition-all">âš™ï¸ ×”×’×“×¨×•×ª ×•×™×¦×™×¨×”</button>
    </nav>

    <div class="p-4 border-t border-slate-100 space-y-2">
      <a href="schedule.html" class="block w-full text-center py-2 rounded-xl bg-slate-100 text-slate-700 text-xs font-black hover:bg-slate-200 transition-colors">×—×–×¨×” ×œ×¡×™×“×•×¨</a>
      <button id="logout" class="block w-full text-center py-2 rounded-xl bg-rose-50 text-rose-700 text-xs font-black hover:bg-rose-100 transition-colors">×”×ª× ×ª×§</button>
    </div>
  </aside>

  <main class="flex-1 p-4 lg:p-8 overflow-y-auto">
    
    <section id="tab-requests" class="panel max-w-4xl mx-auto">
      <div class="flex items-center justify-between mb-6">
        <div>
          <h2 class="text-2xl font-black text-slate-800">×‘×§×©×•×ª ×©×™×‘×•×¥</h2>
          <p class="text-sm text-slate-500 font-medium">××™×©×•×¨ ××• ×“×—×™×™×” ×©×œ ×‘×§×©×•×ª ××©××¨×ª ×”×××ª×™× ×•×ª ×œ×˜×™×¤×•×œ</p>
        </div>
        <button id="reloadRequests" class="p-2 bg-white border border-slate-200 rounded-lg text-slate-600 hover:text-indigo-600 shadow-sm transition-all">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.566 1 1 0 11-1.885.666A5.002 5.002 0 005.999 7H9a1 1 0 010 2H4a1 1 0 01-1-1V3a1 1 0 011-1zm.008 9.057a1 1 0 011.276.61A5.002 5.002 0 0014.001 13H11a1 1 0 110-2h5a1 1 0 011 1v5a1 1 0 11-2 0v-2.101a7.002 7.002 0 01-11.601-2.566 1 1 0 01.61-1.276z" clip-rule="evenodd" /></svg>
        </button>
      </div>
      <div id="requestsBox" class="space-y-3"></div>
      <div id="requestsMsg" class="mt-4 text-center text-sm font-bold text-slate-400"></div>
    </section>

    <section id="tab-users" class="panel hidden max-w-5xl mx-auto">
      <div class="bg-white rounded-3xl border border-slate-200 shadow-sm overflow-hidden">
        <div class="p-6 border-b border-slate-100 flex flex-col sm:flex-row justify-between gap-4">
          <div>
            <h2 class="text-xl font-black text-slate-800">×××’×¨ ××©×ª××©×™×</h2>
            <p class="text-xs text-slate-500 font-bold">× ×™×”×•×œ ×”×¨×©××•×ª ×•×¤×¨×˜×™× ××™×©×™×™×</p>
          </div>
          <input id="userSearch" class="px-4 py-2 rounded-xl bg-slate-50 border border-slate-200 text-sm font-bold w-full sm:w-64 focus:ring-2 focus:ring-indigo-500/20 outline-none" placeholder="×—×™×¤×•×© ×©×, ×˜×œ×¤×•×Ÿ..." />
        </div>
        <div class="p-2 bg-slate-50">
           <div id="usersBox" class="space-y-1"></div>
        </div>
      </div>
    </section>

    <section id="tab-shifts" class="panel hidden max-w-5xl mx-auto">
      <div class="bg-white rounded-3xl p-6 shadow-sm border border-slate-200 mb-6">
        <h2 class="text-lg font-black text-slate-800 mb-4">×¡×™× ×•×Ÿ ××©××¨×•×ª</h2>
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-5 gap-3">
          <input id="dateFrom" type="date" class="p-2.5 rounded-xl border border-slate-200 text-sm font-bold" />
          <input id="dateTo" type="date" class="p-2.5 rounded-xl border border-slate-200 text-sm font-bold" />
          <select id="slot" class="p-2.5 rounded-xl border border-slate-200 text-sm font-bold bg-white">
            <option value="">×”×›×œ</option>
            <option value="weekday_morning">×‘×•×§×¨ (×-×”)</option>
            <option value="weekday_evening">×¢×¨×‘ (×-×”)</option>
            <option value="weekday_night">×œ×™×œ×” (×-×”)</option>
            <option value="fri_morning">×©×™×©×™ ×‘×•×§×¨</option>
            <option value="sat_morning">×©×‘×ª ×‘×•×§×¨</option>
            <option value="sat_night">×©×‘×ª ×œ×™×œ×”</option>
            <option value="motsash_night">××•×¦×´×©</option>
          </select>
          <select id="locked" class="p-2.5 rounded-xl border border-slate-200 text-sm font-bold bg-white">
            <option value="">××¦×‘ × ×¢×™×œ×”</option>
            <option value="true">× ×¢×•×œ×™× ×‘×œ×‘×“</option>
            <option value="false">×¤×ª×•×—×™× ×‘×œ×‘×“</option>
          </select>
          <button id="searchShifts" class="bg-slate-800 text-white rounded-xl font-black text-sm hover:bg-slate-700">×—×¤×©</button>
        </div>
      </div>

      <div class="bg-indigo-900 rounded-3xl p-4 shadow-lg text-white mb-6 flex flex-wrap gap-3 items-center">
        <span class="text-xs font-black opacity-50 px-2">×¤×¢×•×œ×•×ª ×¢×œ × ×‘×—×¨×™×:</span>
        <button id="bulkLock" class="px-3 py-1.5 rounded-lg bg-white/10 hover:bg-white/20 text-xs font-bold transition-colors">ğŸ”’ × ×¢×œ</button>
        <button id="bulkUnlock" class="px-3 py-1.5 rounded-lg bg-white/10 hover:bg-white/20 text-xs font-bold transition-colors">ğŸ”“ ×©×—×¨×¨</button>
        <div class="flex-1 flex gap-2 min-w-[200px]">
          <input id="bulkNote" class="flex-1 bg-black/20 border border-white/10 rounded-lg px-3 text-xs placeholder-white/40 text-white" placeholder="×”×¢×¨×” ×’×•×¨×¤×ª..." />
          <button id="applyNote" class="px-3 py-1.5 rounded-lg bg-emerald-500 hover:bg-emerald-400 text-xs font-bold shadow-lg shadow-emerald-900/20">×©××•×¨ ×”×¢×¨×”</button>
        </div>
      </div>

      <div id="shiftsMsg" class="text-xs font-bold text-slate-400 mb-2 px-2"></div>
      <div id="shiftsBox" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-3"></div>
    </section>

    <section id="tab-generate" class="panel hidden max-w-2xl mx-auto">
      <div class="bg-white rounded-3xl border border-slate-200 shadow-sm p-8 text-center relative overflow-hidden">
        <div class="absolute top-0 left-0 w-full h-2 bg-gradient-to-r from-indigo-500 via-purple-500 to-pink-500"></div>
        
        <h2 class="text-2xl font-black text-slate-800 mb-2">××—×•×œ×œ ×”××©××¨×•×ª</h2>
        <p class="text-slate-500 text-sm font-medium mb-8">×™×¦×™×¨×ª ×©×œ×“ ××©××¨×•×ª ×¨×™×§ ×§×“×™××” ×œ×¤×™ ×”×ª×‘× ×™×ª ×”×§×‘×•×¢×”</p>

        <div class="max-w-xs mx-auto space-y-4">
          <div class="text-left">
            <label class="text-xs font-bold text-slate-400 mb-1 block">××¡×¤×¨ ×©×‘×•×¢×•×ª ×œ×™×¦×™×¨×”</label>
            <input id="weeks" type="number" value="8" class="w-full text-center p-3 rounded-xl border border-slate-200 text-xl font-black" />
          </div>
          <div class="text-left">
             <label class="text-xs font-bold text-slate-400 mb-1 block">×ª××¨×™×š ×”×ª×—×œ×” (××•×¤×¦×™×•× ×œ×™)</label>
             <input id="startDate" type="date" class="w-full p-3 rounded-xl border border-slate-200 font-bold" />
          </div>
        </div>

        <div class="mt-8 grid grid-cols-1 gap-3">
          <button id="generate" class="py-4 rounded-xl bg-slate-800 hover:bg-slate-700 text-white font-black shadow-lg shadow-slate-200 transition-all">
            ğŸš€ ×¦×•×¨ ××©××¨×•×ª
          </button>
          <button id="fillCalendar" class="py-3 rounded-xl bg-indigo-50 hover:bg-indigo-100 text-indigo-700 font-bold transition-all">
            ğŸ“… ×¨×¢× ×Ÿ × ×ª×•× ×™ ×¤×¨×©×” ×•×—×’×™×
          </button>
        </div>

        <div id="genMsg" class="mt-4 text-sm font-bold text-emerald-600"></div>
        
        <div class="mt-4 bg-slate-100 rounded-full h-2 overflow-hidden w-full max-w-xs mx-auto">
          <div id="calProgress" class="bg-indigo-500 h-full w-0 transition-all duration-300"></div>
        </div>
        <div class="flex justify-between text-[10px] font-bold text-slate-400 mt-1 max-w-xs mx-auto">
           <span id="calProgressText"></span>
           <span id="calProgressPct"></span>
        </div>
      </div>
    </section>

  </main>
</div>

<script type="module">
  import { loadLogo, requireAchmashPage, logout, apiGet, apiPost, esc, setTopNow, toast } from "./app.js";

  requireAchmashPage();
  loadLogo(document.getElementById("logo"));
  document.getElementById("logout").onclick = logout;

  const topNow = document.getElementById("topNow");
  setTopNow(topNow);
  setInterval(()=>setTopNow(topNow), 30000);

  /* Navigation Logic */
  function activate(tab){
    document.querySelectorAll(".panel").forEach(p => p.classList.add("hidden"));
    document.querySelectorAll(".nav-btn").forEach(b => b.classList.remove("active"));
    
    document.getElementById("tab-"+tab).classList.remove("hidden");
    document.querySelector(`button[data-tab="${tab}"]`).classList.add("active");
  }
  document.querySelectorAll("button[data-tab]").forEach(b => b.onclick = ()=>activate(b.dataset.tab));

  /* REQUESTS */
  const requestsBox = document.getElementById("requestsBox");
  
  function requestRow(r){
    return `
      <div class="bg-white border border-slate-200 p-4 rounded-2xl flex flex-col md:flex-row gap-4 items-start md:items-center shadow-sm">
        <div class="flex-1">
          <div class="flex items-center gap-2 mb-1">
             <span class="px-2 py-0.5 bg-indigo-50 text-indigo-700 text-[10px] font-black rounded uppercase">${esc(r.shiftSlot)}</span>
             <span class="text-sm font-black text-slate-800">${esc(r.shiftDate)}</span>
          </div>
          <div class="text-lg font-medium text-slate-800">${esc(r.userName)}</div>
          <div class="text-xs text-slate-400 font-bold">${esc(r.userPhone||"")} â€¢ ××©××¨×ª: ${r.assigned}/${r.capacity} ${r.shiftLocked?"(× ×¢×•×œ)":""}</div>
          ${r.shiftNote ? `<div class="mt-2 text-xs bg-amber-50 text-amber-800 px-2 py-1 rounded inline-block font-bold">ğŸ“¢ ${esc(r.shiftNote)}</div>` : ""}
        </div>
        <div class="flex gap-2 w-full md:w-auto">
          <button data-approve="${esc(r.id)}" class="flex-1 md:flex-none px-4 py-2 bg-emerald-500 hover:bg-emerald-600 text-white rounded-xl font-bold shadow-sm shadow-emerald-200 transition-all">××©×¨</button>
          <button data-reject="${esc(r.id)}" class="flex-1 md:flex-none px-4 py-2 bg-rose-50 hover:bg-rose-100 text-rose-600 rounded-xl font-bold transition-all">×“×—×”</button>
        </div>
      </div>
    `;
  }

  async function loadRequests(){
    const msg = document.getElementById("requestsMsg");
    msg.textContent = "×˜×•×¢×Ÿ...";
    const r = await apiGet("adminRequests");
    if(!r.ok){ msg.textContent = r.error; return; }
    
    requestsBox.innerHTML = (r.requests||[]).map(requestRow).join("") || 
      `<div class="text-center py-12 text-slate-400">
         <div class="text-4xl mb-2">âœ¨</div>
         ××™×Ÿ ×‘×§×©×•×ª ×××ª×™× ×•×ª
       </div>`;
    msg.textContent = "";
    
    // Update Badge
    const count = (r.requests||[]).length;
    document.getElementById("reqCount").textContent = count;
    document.getElementById("reqCount").style.display = count > 0 ? "inline-block" : "none";

    // Bindings
    document.querySelectorAll("button[data-approve]").forEach(btn=>{
      btn.onclick = async ()=>{
        if(await apiPost("adminApproveRequest", {requestId:btn.dataset.approve}).then(x=>x.ok)){
          toast("×‘×§×©×” ××•×©×¨×”", "ok"); loadRequests();
        } else toast("×©×’×™××”", "err");
      };
    });
    document.querySelectorAll("button[data-reject]").forEach(btn=>{
      btn.onclick = async ()=>{
        if(await apiPost("adminRejectRequest", {requestId:btn.dataset.reject}).then(x=>x.ok)){
          toast("×‘×§×©×” × ×“×—×ª×”", "info"); loadRequests();
        } else toast("×©×’×™××”", "err");
      };
    });
  }
  document.getElementById("reloadRequests").onclick = loadRequests;

  /* USERS */
  let allUsers = [];
  function userRow(u){
    return `
      <div class="bg-white p-3 rounded-xl border border-slate-100 flex items-center justify-between hover:border-indigo-200 transition-colors">
        <div class="flex items-center gap-3">
           <div class="w-10 h-10 rounded-full bg-slate-100 flex items-center justify-center text-slate-500 font-black text-xs">
             ${u.name ? u.name.slice(0,2) : "??"}
           </div>
           <div>
             <div class="font-bold text-slate-800 text-sm">${esc(u.name)}</div>
             <div class="text-[11px] text-slate-400 font-mono">${esc(u.phone)}</div>
           </div>
        </div>
        <div class="flex gap-2">
           <button data-appr="${esc(u.id)}" class="px-3 py-1.5 rounded-lg text-xs font-black transition-colors ${u.approved ? "bg-emerald-50 text-emerald-600" : "bg-slate-200 text-slate-600"}">
             ${u.approved ? "×××•×©×¨" : "×××ª×™×Ÿ"}
           </button>
           <button data-edit="${esc(u.id)}" class="px-3 py-1.5 rounded-lg bg-white border border-slate-200 text-slate-500 hover:text-indigo-600 text-xs font-bold">×¢×¨×•×š</button>
        </div>
      </div>
    `;
  }
  
  async function loadUsers(){
    const r = await apiGet("adminUsers");
    if(r.ok) { allUsers = r.users||[]; renderUsers(); }
  }
  function renderUsers(){
    const q = document.getElementById("userSearch").value.toLowerCase();
    const list = allUsers.filter(u=> (u.name+u.phone).toLowerCase().includes(q));
    document.getElementById("usersBox").innerHTML = list.map(userRow).join("");
    // Rebind
    document.querySelectorAll("button[data-appr]").forEach(btn=>{
       btn.onclick = async ()=>{
         const u = allUsers.find(x=>x.id===btn.dataset.appr);
         await apiPost("adminUpdateUser", {userId:u.id, approved:!u.approved});
         loadUsers();
       };
    });
    document.querySelectorAll("button[data-edit]").forEach(btn=>{
       btn.onclick = async ()=>{
         const u = allUsers.find(x=>x.id===btn.dataset.edit);
         const name = prompt("×©×", u.name); if(name===null)return;
         const phone = prompt("×˜×œ×¤×•×Ÿ", u.phone); if(phone===null)return;
         const role = prompt("×ª×¤×§×™×“ (achmash/user)", u.role); if(role===null)return;
         await apiPost("adminUpdateUser", {userId:u.id, name, phone, role});
         loadUsers();
       };
    });
  }
  document.getElementById("userSearch").oninput = renderUsers;

  /* SHIFTS */
  let lastShifts = [];
  let selected = new Set();
  
  function shiftCard(s){
    const active = selected.has(s.id);
    return `
      <div class="relative bg-white border ${active?'border-indigo-500 ring-1 ring-indigo-500':'border-slate-200'} p-3 rounded-2xl cursor-pointer hover:shadow-md transition-all" onclick="this.querySelector('input').click()">
        <input type="checkbox" class="hidden" data-id="${esc(s.id)}" ${active?'checked':''} onchange="window.toggleShift('${esc(s.id)}')" />
        <div class="flex justify-between items-start mb-2">
           <div class="text-xs font-black text-slate-400 uppercase tracking-wider">${esc(s.slotLabel)}</div>
           ${s.locked ? '<span class="text-[10px] bg-slate-100 text-slate-500 px-1.5 py-0.5 rounded font-bold">ğŸ”’</span>' : ''}
        </div>
        <div class="font-black text-slate-800 text-sm mb-1">${esc(s.date)}</div>
        <div class="text-xs font-bold ${s.assigned>=s.capacity ? 'text-emerald-600':'text-slate-500'}">
           ${s.assigned}/${s.capacity} ××©×•×‘×¦×™×
        </div>
        ${s.note ? `<div class="mt-2 text-[10px] bg-amber-50 text-amber-800 p-1 rounded border border-amber-100 truncate">${esc(s.note)}</div>` : ''}
      </div>
    `;
  }

  // Global scope for onclick html handler (simple hack for module)
  window.toggleShift = (id) => {
    if(selected.has(id)) selected.delete(id); else selected.add(id);
    renderShifts();
  };

  function renderShifts(){
    const box = document.getElementById("shiftsBox");
    box.innerHTML = lastShifts.map(shiftCard).join("");
    document.getElementById("shiftsMsg").textContent = `× ××¦××• ${lastShifts.length} | × ×‘×—×¨×• ${selected.size}`;
  }

  document.getElementById("searchShifts").onclick = async ()=>{
    const p = {
       dateFrom: document.getElementById("dateFrom").value,
       dateTo: document.getElementById("dateTo").value,
       slot: document.getElementById("slot").value,
       locked: document.getElementById("locked").value
    };
    const r = await apiGet("adminShifts", p);
    if(r.ok) { lastShifts = r.shifts||[]; selected.clear(); renderShifts(); }
  };

  async function bulk(data){
    if(!selected.size) return toast("×œ× × ×‘×—×¨×• ××©××¨×•×ª", "err");
    const r = await apiPost("adminBulkUpdateShifts", {shiftIds:Array.from(selected), ...data});
    if(r.ok) { toast("×¢×•×“×›×Ÿ ×‘×”×¦×œ×—×”", "ok"); document.getElementById("searchShifts").click(); }
  }
  document.getElementById("bulkLock").onclick = ()=>bulk({locked:true});
  document.getElementById("bulkUnlock").onclick = ()=>bulk({locked:false});
  document.getElementById("applyNote").onclick = ()=>bulk({note:document.getElementById("bulkNote").value});

  /* GENERATE */
  document.getElementById("generate").onclick = async ()=>{
     if(!confirm("×”×× ××ª×” ×‘×˜×•×—?")) return;
     const r = await apiPost("adminGenerateWeeks", {
       weeks: document.getElementById("weeks").value,
       startDate: document.getElementById("startDate").value
     });
     document.getElementById("genMsg").textContent = r.ok ? `× ×•×¦×¨×• ${r.created} ××©××¨×•×ª!` : "×©×’×™××”";
  };

  document.getElementById("fillCalendar").onclick = async ()=>{
     const weeks = Number(document.getElementById("weeks").value);
     const start = document.getElementById("startDate").value;
     const bar = document.getElementById("calProgress");
     const txt = document.getElementById("calProgressText");
     
     // Calculate date ranges logic (simplified for UI demo)
     // In real app, reuse the logic from original admin.html
     // Here we just trigger the loop visually
     let base = start ? new Date(start) : new Date();
     base.setHours(0,0,0,0);
     const sunday0 = new Date(base); sunday0.setDate(base.getDate()-base.getDay());

     for(let w=0; w<weeks; w++){
        const sun = new Date(sunday0); sun.setDate(sunday0.getDate()+w*7);
        const sat = new Date(sun); sat.setDate(sun.getDate()+6);
        
        txt.textContent = `××¢×“×›×Ÿ ×©×‘×•×¢ ${w+1}...`;
        await apiPost("adminFillCalendarRange", { 
           start: sun.toISOString().slice(0,10), 
           end: sat.toISOString().slice(0,10) 
        });
        bar.style.width = Math.round(((w+1)/weeks)*100) + "%";
        document.getElementById("calProgressPct").textContent = Math.round(((w+1)/weeks)*100) + "%";
     }
     txt.textContent = "×¡×™×•×!";
     toast("×œ×•×— ×©× ×” ×¢×•×“×›×Ÿ", "ok");
  };

  // Init
  activate("requests");
  loadRequests();
  loadUsers();

</script>
</body>
</html>
