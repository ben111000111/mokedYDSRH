<!doctype html>
<html lang="he" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>שבתות | מערכת מוקד</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Heebo:wght@400;600;800;900&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>

  <style>*{font-family:Heebo,system-ui,-apple-system,Segoe UI,Arial,sans-serif;}</style>
</head>

<body class="min-h-screen bg-slate-100">
<div id="toast" style="display:none;"></div>

<header class="sticky top-0 z-50 bg-white/80 backdrop-blur border-b border-slate-200">
  <div class="max-w-6xl mx-auto px-4 py-3 flex items-center justify-between gap-3">
    <div class="flex items-center gap-3">
      <div id="logo" class="h-10"></div>
      <div>
        <div class="font-black text-slate-900">שבתות</div>
        <div id="topNow" class="text-xs font-bold text-slate-500"></div>
      </div>
    </div>

    <div class="flex items-center gap-2">
      <a class="px-3 py-2 rounded-2xl bg-slate-200 text-slate-900 font-extrabold" href="schedule.html">בית</a>
      <div class="flex rounded-2xl overflow-hidden border border-slate-200 bg-white">
        <button id="viewGrid" class="px-3 py-2 font-extrabold bg-slate-900 text-white">רשת</button>
        <button id="viewList" class="px-3 py-2 font-extrabold text-slate-900">רשימה</button>
      </div>
    </div>
  </div>
</header>

<main class="max-w-6xl mx-auto p-4">
  <div class="flex flex-col sm:flex-row sm:items-end justify-between gap-3 mb-4">
    <div>
      <div class="text-2xl font-black text-slate-900">תצוגת שבתות</div>
      <div class="text-sm font-bold text-slate-500">כולל משובצים בחוץ + פרטים בלחיצה</div>
    </div>
    <div class="flex gap-2">
      <button id="prev" class="px-4 py-2 rounded-2xl bg-white border border-slate-200 font-extrabold">◀</button>
      <button id="next" class="px-4 py-2 rounded-2xl bg-white border border-slate-200 font-extrabold">▶</button>
    </div>
  </div>

  <div id="wrap" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4"></div>
  <div id="msg" class="mt-4 text-sm font-bold text-slate-600"></div>
</main>

<script type="module">
  import { CONFIG } from "./config.js";
  import { loadLogo, requireLogin, apiGet, esc, hebrewDateString, isoDate, setTopNow } from "./app.js";

  requireLogin();
  loadLogo(document.getElementById("logo"));

  const topNow = document.getElementById("topNow");
  setTopNow(topNow);
  setInterval(()=>setTopNow(topNow), 30000);

  let anchor = new Date();
  let mode = "grid";

  function setMode(m){
    mode = m;
    document.getElementById("viewGrid").className = "px-3 py-2 font-extrabold " + (mode==="grid" ? "bg-slate-900 text-white" : "text-slate-900");
    document.getElementById("viewList").className = "px-3 py-2 font-extrabold " + (mode==="list" ? "bg-slate-900 text-white" : "text-slate-900");
    document.getElementById("wrap").className =
      mode==="grid"
        ? "grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4"
        : "space-y-3";
  }

  document.getElementById("viewGrid").onclick=()=>setMode("grid");
  document.getElementById("viewList").onclick=()=>setMode("list");

  function shiftLine(s){
    const names = (s.assignees||[]).map(a=>esc(a.userName)).join(" • ");
    return `
      <div class="flex items-center justify-between gap-2">
        <div class="text-sm font-black text-slate-900">${esc(s.label)}</div>
        <div class="text-xs font-bold text-slate-500">${names || "—"}</div>
      </div>
    `;
  }

  function card(day){
    const heb = hebrewDateString(new Date(day.date+"T00:00:00"));
    const extras = [day.parasha, day.holidays].filter(Boolean).join(" • ");
    return `
      <section class="bg-white/70 backdrop-blur border border-white rounded-[28px] shadow-sm overflow-hidden">
        <div class="p-4">
          <div class="text-lg font-black text-slate-900">${esc(day.title)} • ${esc(day.date)}</div>
          <div class="text-xs font-bold text-slate-500">${esc(heb)}</div>
          ${extras ? `<div class="text-xs font-black text-slate-700 mt-1">${esc(extras)}</div>` : ""}

          <div class="mt-3 space-y-2">
            ${(day.shifts||[]).map(shiftLine).join("") || `<div class="text-sm font-bold text-slate-400">אין משמרות</div>`}
          </div>

          <button data-open="${esc(day.date)}"
            class="mt-4 w-full py-2 rounded-2xl bg-slate-900 text-white font-extrabold">
            פרטים נוספים
          </button>

          <div id="more-${esc(day.date)}" class="hidden mt-3 text-xs font-bold text-slate-600"></div>
        </div>
      </section>
    `;
  }

  async function load(){
    msg.textContent = "טוען שבתות…";

    // load 8 weeks ahead by calling getWeek for each week and extracting שבת
    const weeks = [];
    const start = new Date(anchor);
    start.setHours(0,0,0,0);

    for(let i=0;i<8;i++){
      const d = new Date(start);
      d.setDate(start.getDate() + i*7);
      weeks.push(isoDate(d));
    }

    const days = [];
    for(const w of weeks){
      const r = await apiGet("getWeek", { date: w });
      if(r.ok && Array.isArray(r.days)){
        // last day is שבת (we return it last)
        const shabbatDay = r.days[r.days.length-1];
        days.push(shabbatDay);
      }
    }

    wrap.innerHTML = days.map(card).join("");
    msg.textContent = "";

    document.querySelectorAll("button[data-open]").forEach(btn=>{
      btn.onclick = ()=>{
        const key = btn.dataset.open;
        const box = document.getElementById("more-"+key);
        const isOpen = !box.classList.contains("hidden");
        if(isOpen){ box.classList.add("hidden"); return; }
        box.textContent = "תאריך (שבת): " + key + " | מוצ״ש לילה שייך לתאריך שבת.";
        box.classList.remove("hidden");
      };
    });
  }

  prev.onclick=()=>{ anchor.setDate(anchor.getDate()-7); load(); };
  next.onclick=()=>{ anchor.setDate(anchor.getDate()+7); load(); };

  setMode("grid");
  load();
</script>
</body>
</html>
