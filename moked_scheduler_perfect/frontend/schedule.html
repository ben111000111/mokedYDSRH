<!doctype html>
<html lang="he" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>×¡×™×“×•×¨ ×©×‘×•×¢×™</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;500;700;900&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { font-family: 'Heebo', sans-serif; background-color: #f8fafc; }
    /* Scrollbar hide */
    .no-scrollbar::-webkit-scrollbar { display: none; }
    .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    .glass-header { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(12px); border-bottom: 1px solid rgba(226, 232, 240, 0.8); }
    .day-card { transition: transform 0.2s ease, box-shadow 0.2s ease; }
    .day-card:hover { transform: translateY(-2px); box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.05), 0 8px 10px -6px rgba(0, 0, 0, 0.01); }
  </style>
</head>

<body class="min-h-screen text-slate-800">
<div id="toast" style="display:none;"></div>

<header class="sticky top-0 z-50 glass-header">
  <div class="max-w-7xl mx-auto px-4 h-16 flex items-center justify-between gap-4">
    <div class="flex items-center gap-4">
      <div id="logo" class="h-8 w-auto"></div>
      <div class="hidden md:block w-px h-6 bg-slate-200"></div>
      <div>
        <h1 id="appName" class="text-lg font-black text-slate-800 leading-none"></h1>
        <div id="topNow" class="text-[11px] font-bold text-indigo-600 mt-0.5"></div>
      </div>
    </div>

    <div class="flex items-center gap-2">
      <a id="adminBtn" class="hidden px-4 py-2 rounded-xl bg-slate-800 hover:bg-slate-700 text-white text-xs font-bold transition-colors" href="admin.html">× ×™×”×•×œ</a>
      <a class="px-4 py-2 rounded-xl bg-indigo-50 hover:bg-indigo-100 text-indigo-700 text-xs font-bold transition-colors" href="shabbat.html">×©×‘×ª×•×ª</a>
      <button id="logout" class="px-4 py-2 rounded-xl bg-rose-50 hover:bg-rose-100 text-rose-700 text-xs font-bold transition-colors">×™×¦×™××”</button>
    </div>
  </div>
</header>

<main class="max-w-7xl mx-auto p-4 md:p-6 space-y-8">
  
  <div class="flex flex-col md:flex-row md:items-end justify-between gap-4 bg-white p-6 rounded-3xl shadow-sm border border-slate-100">
    <div>
      <h2 id="weekTitle" class="text-3xl font-black text-slate-800 tracking-tight mb-1"></h2>
      <div class="flex items-center gap-2 text-slate-500 font-medium text-sm">
        <span class="w-2 h-2 rounded-full bg-emerald-500"></span>
        <span id="weekRange"></span>
      </div>
    </div>
    
    <div class="flex items-center bg-slate-100 p-1 rounded-2xl">
      <button id="prevWeek" class="w-10 h-10 flex items-center justify-center rounded-xl hover:bg-white hover:shadow-sm text-slate-600 transition-all">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd" transform="rotate(180 10 10)" /></svg>
      </button>
      <button id="today" class="px-4 h-10 rounded-xl text-xs font-black text-slate-700 hover:bg-white hover:shadow-sm transition-all">×”×©×‘×•×¢</button>
      <button id="nextWeek" class="w-10 h-10 flex items-center justify-center rounded-xl hover:bg-white hover:shadow-sm text-slate-600 transition-all">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd" /></svg>
      </button>
    </div>
  </div>

  <div id="grid" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-4 gap-6"></div>

  <div class="text-center py-8">
    <div id="msg" class="inline-block px-4 py-2 bg-slate-200 rounded-full text-xs font-bold text-slate-600 animate-pulse"></div>
  </div>
</main>

<script type="module">
  import { CONFIG } from "./config.js";
  import { loadLogo, requireLogin, logout, apiGet, apiPost, esc, hebrewDateString, isoDate, setTopNow, isAchmash, toast } from "./app.js";

  requireLogin();
  document.getElementById("appName").textContent = CONFIG.APP_NAME;
  loadLogo(document.getElementById("logo"));
  document.getElementById("logout").onclick = logout;
  if (isAchmash()) document.getElementById("adminBtn").classList.remove("hidden");

  const topNow = document.getElementById("topNow");
  setTopNow(topNow);
  setInterval(()=>setTopNow(topNow), 30000);

  let anchor = new Date();

  function shiftCard(s, day) {
    const disabled = s.locked || s.missing <= 0;
    const isFull = s.missing <= 0;
    
    // Status Badge Logic
    let statusClass = "bg-emerald-100 text-emerald-700 ring-1 ring-emerald-500/20";
    let statusText = "×¤× ×•×™";
    if (s.locked) {
      statusClass = "bg-slate-100 text-slate-500 ring-1 ring-slate-500/10";
      statusText = "× ×¢×•×œ";
    } else if (isFull) {
      statusClass = "bg-rose-50 text-rose-700 ring-1 ring-rose-500/10";
      statusText = "××œ×";
    }

    const assignedNames = (s.assignees || []).map(x => 
      `<span class="inline-block bg-slate-50 border border-slate-200 rounded-md px-1.5 py-0.5 text-[10px] text-slate-700 font-bold">${esc(x.userName)}</span>`
    ).join("");

    return `
      <div class="group relative bg-white border border-slate-100 rounded-2xl p-4 transition-all hover:border-indigo-100 hover:shadow-md">
        
        <div class="flex items-start justify-between mb-3">
          <div>
            <div class="text-[11px] font-black uppercase tracking-wide text-slate-400 mb-0.5">${esc(s.label)}</div>
            <div class="text-sm font-bold text-slate-800 flex items-center gap-1.5">
              <span>${s.assigned}/${s.capacity} ××©×•×‘×¦×™×</span>
            </div>
          </div>
          <span class="px-2 py-1 rounded-lg text-[10px] font-black ${statusClass}">${statusText}</span>
        </div>

        ${s.note ? `
          <div class="mb-3 px-3 py-2 bg-amber-50 rounded-lg border border-amber-100">
            <div class="text-[10px] font-bold text-amber-800 flex items-start gap-1">
              <span class="text-amber-500 text-xs">â„¹</span> ${esc(s.note)}
            </div>
          </div>` : ""}

        <div class="flex flex-wrap gap-1 mb-4 min-h-[1.5rem] content-start">
          ${assignedNames || `<span class="text-[10px] text-slate-300 italic">×˜×¨× ×©×•×‘×¦×•</span>`}
        </div>

        <div class="flex gap-2 mt-auto">
          <button data-request="${esc(s.id)}"
            class="flex-1 py-2 rounded-xl text-xs font-black shadow-sm transition-all active:scale-95
            ${disabled ? "bg-slate-100 text-slate-400 cursor-not-allowed" : "bg-indigo-600 hover:bg-indigo-700 text-white shadow-indigo-200"}"
            ${disabled ? "disabled" : ""}>
            ${isFull ? "××œ×" : "×‘×§×© ××©××¨×ª"}
          </button>
           <button data-more="${esc(s.id)}" class="px-3 py-2 rounded-xl bg-white border border-slate-200 text-slate-600 hover:text-indigo-600 hover:border-indigo-200 text-xs font-black transition-colors">
            ?
          </button>
        </div>
        
        <div id="more-${esc(s.id)}" class="hidden mt-3 pt-3 border-t border-slate-100 text-[10px] text-slate-400 font-mono text-center">
           ID: ${esc(s.id)}
        </div>
      </div>
    `;
  }

  function dayCard(day) {
    const d = new Date(day.date);
    const dayNum = d.getDate();
    const dayName = day.title;
    
    return `
      <section class="day-card flex flex-col h-full bg-white rounded-3xl border border-slate-200/60 shadow-sm overflow-hidden relative">
        <div class="p-5 bg-gradient-to-b from-slate-50 to-white border-b border-slate-100">
          <div class="flex items-start justify-between">
            <div>
              <div class="text-2xl font-black text-slate-800">${dayName}</div>
              <div class="text-xs font-bold text-slate-500 mt-1">${day.hebrewDate || ""}</div>
            </div>
            <div class="text-center bg-white border border-slate-200 rounded-xl px-2.5 py-1.5 shadow-sm">
              <span class="block text-xl font-black text-indigo-600 leading-none">${dayNum}</span>
              <span class="block text-[10px] font-bold text-slate-400 uppercase">×œ×—×•×“×©</span>
            </div>
          </div>
          
          ${(day.parasha || day.holidays) ? `
            <div class="mt-3 flex flex-wrap gap-1.5">
              ${day.parasha ? `<span class="px-2 py-0.5 rounded-md bg-indigo-50 text-indigo-700 text-[10px] font-bold border border-indigo-100">ğŸ“– ${esc(day.parasha)}</span>` : ""}
              ${Array.from(day.holidays || []).map(h => `<span class="px-2 py-0.5 rounded-md bg-rose-50 text-rose-700 text-[10px] font-bold border border-rose-100">ğŸ— ${esc(h)}</span>`).join("")}
            </div>
          ` : ""}
        </div>

        <div class="p-4 space-y-3 flex-1 bg-slate-50/50">
          ${(day.shifts || []).map(s => shiftCard(s, day)).join("") || 
            `<div class="h-32 flex flex-col items-center justify-center text-slate-300 border-2 border-dashed border-slate-200 rounded-2xl">
               <span class="text-2xl opacity-50">ğŸ˜´</span>
               <span class="text-xs font-bold mt-2">××™×Ÿ ××©××¨×•×ª</span>
             </div>`
          }
        </div>
      </section>
    `;
  }

  async function loadWeek() {
    document.getElementById("msg").textContent = "×˜×•×¢×Ÿ × ×ª×•× ×™×...";
    document.getElementById("msg").style.display = "inline-block";
    
    const r = await apiGet("getWeek", { date: isoDate(anchor) });

    if (!r.ok) {
      document.getElementById("msg").textContent = r.error || "×©×’×™××” ×‘×˜×¢×™× ×ª ×”× ×ª×•× ×™×";
      document.getElementById("msg").className = "inline-block px-4 py-2 bg-rose-100 text-rose-700 rounded-full text-xs font-bold";
      return;
    }
    
    document.getElementById("msg").style.display = "none";
    document.getElementById("weekTitle").textContent = r.weekParasha ? `×¤×¨×©×ª ${r.weekParasha}` : "×¡×™×“×•×¨ ×¢×‘×•×“×”";
    document.getElementById("weekRange").textContent = `${r.start} â€“ ${r.end}`;

    // Fix holidays format if it comes as string
    (r.days || []).forEach(d => {
       if (typeof d.holidays === 'string' && d.holidays) d.holidays = [d.holidays];
    });

    document.getElementById("grid").innerHTML = (r.days || []).map(dayCard).join("");

    // Bindings
    document.querySelectorAll("button[data-request]").forEach(btn => {
      btn.onclick = async () => {
        const shiftId = btn.dataset.request;
        btn.disabled = true;
        btn.innerHTML = `<svg class="animate-spin h-4 w-4 mx-auto text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>`;
        
        const rr = await apiPost("requestShift", { shiftId });
        if (rr.ok) toast("×”×‘×§×©×” × ×©×œ×—×” ×œ××—××´×© ×‘×”×¦×œ×—×”", "ok");
        else {
           toast(rr.error || "×©×’×™××”", "err");
           btn.disabled = false;
           btn.textContent = "×‘×§×© ××©××¨×ª";
        }
        await loadWeek();
      };
    });

    document.querySelectorAll("button[data-more]").forEach(btn => {
      btn.onclick = () => {
        const id = btn.dataset.more;
        const box = document.getElementById("more-" + id);
        box.classList.toggle("hidden");
      };
    });
  }

  document.getElementById("prevWeek").onclick = () => { anchor.setDate(anchor.getDate() - 7); loadWeek(); };
  document.getElementById("nextWeek").onclick = () => { anchor.setDate(anchor.getDate() + 7); loadWeek(); };
  document.getElementById("today").onclick = () => { anchor = new Date(); loadWeek(); };

  loadWeek();
</script>
</body>
</html>
