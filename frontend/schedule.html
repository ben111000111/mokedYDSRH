<!doctype html>
<html lang="he" dir="rtl">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>סידור שבועי | מערכת מוקד מצוקה</title>
<script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-slate-100 min-h-screen">
<header class="sticky top-0 bg-white border-b z-50">
  <div class="max-w-6xl mx-auto p-3 flex items-center justify-between gap-3">
    <div class="flex items-center gap-3">
      <div id="logo" class="h-10"></div>
      <div>
        <div class="font-extrabold text-slate-800">מערכת מוקד</div>
        <div id="now" class="text-xs font-bold text-slate-500"></div>
      </div>
    </div>
    <div class="flex gap-2">
      <a id="adminBtn" href="admin.html" class="hidden px-3 py-2 rounded-2xl bg-slate-900 text-white font-extrabold">אדמין</a>
      <button id="logout" class="px-3 py-2 rounded-2xl bg-red-50 text-red-700 font-extrabold">יציאה</button>
    </div>
  </div>
</header>

<main class="p-4 max-w-6xl mx-auto">
  <div class="flex items-center justify-between mb-4">
    <div>
      <div id="weekTitle" class="font-extrabold text-xl text-slate-800"></div>
      <div id="weekRange" class="text-sm font-bold text-slate-500"></div>
    </div>
    <div class="flex gap-2">
      <button id="prev" class="px-4 py-2 rounded-2xl bg-slate-200 font-extrabold">◀</button>
      <button id="next" class="px-4 py-2 rounded-2xl bg-slate-200 font-extrabold">▶</button>
    </div>
  </div>

  <div id="grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4"></div>
  <div id="msg" class="mt-3 font-bold"></div>
</main>

<script type="module">
import { loadLogo, apiGet, apiPost, logout, esc, requireLogin, isAchmash } from "./app.js";

requireLogin();

loadLogo(document.getElementById("logo"));
document.getElementById("logout").onclick = logout;

// show admin button only if achmash
if (isAchmash()) document.getElementById("adminBtn").classList.remove("hidden");

let anchor = new Date();
function fmt(d){ return d.toISOString().slice(0,10); }

function dayCard(day){
  return `
    <div class="bg-white rounded-3xl shadow p-4 relative overflow-hidden">
      <div class="absolute inset-0 flex items-center justify-center opacity-5 pointer-events-none">
        <div class="text-6xl font-black">YSB</div>
      </div>
      <div class="relative">
        <div class="font-extrabold text-slate-800 mb-1">${esc(day.title)}</div>
        <div class="text-xs font-bold text-slate-500 mb-3">
          ${esc(day.hebrewDate||"")} | ${esc(day.date||"")}
          ${day.parasha ? " • "+esc(day.parasha) : ""}
          ${day.holidays ? " • "+esc(day.holidays) : ""}
        </div>

        ${(day.shifts||[]).map(s=>{
          const disabled = s.locked || s.missing<=0;
          return `
            <div class="p-3 rounded-2xl border bg-slate-50 mb-2">
              <div class="text-xs font-black text-slate-500">${esc(s.label)}</div>
              <div class="font-extrabold text-slate-800">מאויש ${s.assigned}/${s.capacity}</div>
              <div class="text-xs font-bold text-slate-500">
                ${s.locked ? "נעול" : (s.missing>0 ? "יש מקום" : "מלא")}
              </div>
              ${s.note ? `<div class="text-xs font-bold text-slate-500 mt-1">הערה: ${esc(s.note)}</div>` : ""}
              <button data-id="${esc(s.id)}"
                class="mt-2 w-full py-2 rounded-xl font-extrabold ${disabled ? "bg-slate-200 text-slate-400" : "bg-blue-600 text-white"}"
                ${disabled?"disabled":""}>הגש בקשה</button>
            </div>
          `;
        }).join("")}
      </div>
    </div>
  `;
}

async function loadWeek(){
  msg.textContent="טוען…";
  const r = await apiGet("getWeek",{ date: fmt(anchor) });
  if(!r.ok){ msg.textContent=r.error||"שגיאה"; return; }

  now.textContent = [
    r.header?.hebrewDate, r.header?.date, r.header?.time,
    r.header?.parasha, r.header?.holidayNames
  ].filter(Boolean).join(" | ");

  weekTitle.textContent = r.weekParasha ? `שבוע פרשת ${r.weekParasha}` : "סידור שבועי";
  weekRange.textContent = `${r.start} – ${r.end}`;

  grid.innerHTML = (r.days||[]).map(dayCard).join("");

  document.querySelectorAll("button[data-id]").forEach(b=>{
    b.onclick = async ()=>{
      msg.textContent="שולח בקשה…";
      const rr = await apiPost("requestShift",{ shiftId: b.dataset.id });
      msg.textContent = rr.ok ? "הבקשה נשלחה ✔" : (rr.error||"שגיאה");
    };
  });

  msg.textContent="";
}

prev.onclick=()=>{ anchor.setDate(anchor.getDate()-7); loadWeek(); };
next.onclick=()=>{ anchor.setDate(anchor.getDate()+7); loadWeek(); };
loadWeek();
</script>
</body>
</html>
