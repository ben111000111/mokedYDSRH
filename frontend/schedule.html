<!doctype html>
<html lang="he" dir="rtl">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>סידור שבועי</title>
<script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-slate-100 min-h-screen">
<header class="bg-white border-b p-3 flex justify-between">
  <div class="flex items-center gap-2">
    <div id="logo"></div>
    <div id="now" class="text-xs font-bold text-slate-500"></div>
  </div>
  <button id="logout" class="text-red-600 font-bold">יציאה</button>
</header>

<main class="p-4 max-w-6xl mx-auto">
  <div class="flex justify-between mb-4">
    <div>
      <div id="weekTitle" class="font-extrabold text-xl"></div>
      <div id="weekRange" class="text-sm text-slate-500"></div>
    </div>
    <div>
      <button id="prev">◀</button>
      <button id="next">▶</button>
    </div>
  </div>

  <div id="grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4"></div>
  <div id="msg" class="mt-3 font-bold"></div>
</main>

<script type="module">
import { loadLogo, apiGet, apiPost, logout, esc } from "./app.js";

loadLogo(document.getElementById("logo"));
document.getElementById("logout").onclick=logout;

let d=new Date();

function fmt(x){return x.toISOString().slice(0,10);}

async function load(){
  const r=await apiGet("getWeek",{date:fmt(d)});
  document.getElementById("now").textContent =
    [r.header.hebrewDate,r.header.date,r.header.time,r.header.parasha].filter(Boolean).join(" | ");

  weekTitle.textContent=r.weekParasha?`שבוע פרשת ${r.weekParasha}`:"סידור שבועי";
  weekRange.textContent=`${r.start} – ${r.end}`;

  grid.innerHTML=r.days.map(day=>`
    <div class="bg-white rounded-2xl p-3 shadow">
      <div class="font-bold mb-1">${day.title}</div>
      <div class="text-xs text-slate-500 mb-2">${day.hebrewDate} | ${day.date}</div>
      ${day.shifts.map(s=>`
        <div class="border rounded-xl p-2 mb-2">
          <div class="font-bold">${s.label}</div>
          <div class="text-xs">מאויש ${s.assigned}/${s.capacity}</div>
          <button ${s.missing===0||s.locked?"disabled":""}
            data-id="${s.id}"
            class="mt-1 w-full rounded-lg py-1 text-white font-bold
            ${s.missing===0||s.locked?"bg-slate-300":"bg-blue-600"}">
            בקשה
          </button>
        </div>
      `).join("")}
    </div>`).join("");

  document.querySelectorAll("button[data-id]").forEach(b=>{
    b.onclick=async()=>{
      const r=await apiPost("requestShift",{shiftId:b.dataset.id});
      msg.textContent=r.ok?"הבקשה נשלחה":"שגיאה";
    };
  });
}
prev.onclick=()=>{d.setDate(d.getDate()-7);load();}
next.onclick=()=>{d.setDate(d.getDate()+7);load();}
load();
</script>
</body>
</html>
